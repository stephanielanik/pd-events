<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upcoming AIT Professional Development</title>

<style>
  :root{
    --brand:#004D86; --brand-hover:#0a5ea2; --brand-active:#084d86;
    --text:#15202b; --muted:#445;
    --bg:transparent;
    --card:#fff; --soft:#f2f4f7;
    --radius:18px;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --shadow-md:0 14px 40px rgba(0,0,0,.12);
    --gap:20px; --nav:48px;                 /* <-- arrow size used for gutters */
    --rail-pad: calc(var(--nav) + 8px);      /* <-- keep heading/tabs aligned to cards */
  }

  body{ margin:0; padding:24px 16px 36px; background:var(--bg); color:var(--text);
        font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

  /* shared width clamp */
  .widget-shell{ max-width:1200px; margin:0 auto; }

  /* this gives the same inner margins as the card rail (inside arrow gutters) */
  .rail-margins{ padding-left:var(--rail-pad); padding-right:var(--rail-pad); }

  h1{ font-size:clamp(1.25rem,1.1rem + 1.1vw,2rem); margin:0 0 12px; }

  /* view toggle */
  .tabs{ display:flex; gap:10px; margin:6px 0 18px; }
  .tab{ appearance:none; border:0; border-radius:999px; padding:10px 14px;
        background:var(--soft); color:var(--text); font-weight:700; cursor:pointer; }
  .tab[aria-selected="true"]{ background:var(--brand); color:#fff; }

  /* carousel */
  .carousel{ position:relative; padding:0 var(--rail-pad); }   /* same gutters as .rail-margins */
  .strip{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:minmax(290px, calc((min(1200px, 100%) - (var(--gap)*2)) / 3));
    gap:var(--gap);
    overflow-x:auto;
    scroll-snap-type:x mandatory;
    padding-left: var(--gap);
    padding-bottom:12px;
    scroll-padding-left: var(--gap);
    padding-right: calc(var(--gap) * .5);
    scroll-padding-right: calc(var(--gap) * .5);
  }
  .strip > article:first-child{
  scroll-margin-left: var(--gap);
}

  /* cards */
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:0 0 0 1px rgba(0,0,0,.07),var(--shadow); }
  .img-wrap{ position:relative; aspect-ratio:16/9; overflow:hidden;
             border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
             background:#e8eef5; }
  .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block; }
  .content{ display:grid; gap:8px; padding:14px 16px 16px; }
  .title{ font-weight:800; font-size:1.6rem; line-height:1.15; }
  .meta{ color:var(--muted); font-weight:700; }
  .card .desc{ color:#333; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:5;
         overflow:hidden; white-space:pre-line; line-height:1.45; }
  .desc.expanded{ -webkit-line-clamp:unset; overflow:visible; max-height:none; }
  .more{ appearance:none; border:0; background:transparent; color:var(--brand);
         font-weight:800; cursor:pointer; margin-top:-4px; width:fit-content; }

  /* CTA */
  .cta{ display:inline-block; text-decoration:none; text-align:center;
        margin-top:10px; padding:12px 14px; border-radius:12px;
        background:var(--brand); color:#fff; font-weight:800; }
  .cta:hover{ background:var(--brand-hover); }
  .cta:active{ background:var(--brand-active); }

  /* arrows */
  .nav{ position:absolute; top:50%; transform:translateY(-50%); width:var(--nav); height:var(--nav);
        border:0; border-radius:999px; display:grid; place-items:center;
        background:var(--brand); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); cursor:pointer; }
  #prevBtn{ left:8px; }  #nextBtn{ right:8px; }
  .nav:hover{ background:var(--brand-hover); } .nav:active{ background:var(--brand-active); }
  .nav[disabled]{ background:#d5dbe3; color:#fff; cursor:not-allowed; opacity:.85; }

  /* agenda */
  .agenda-viewport{ max-height:70vh; overflow:auto;padding: 0 var(--gap);box-sizing: border-box;}   /* <-- self-scrolling panel */
  .agenda-wrap{ padding-top:6px;padding-bottom: 12px;}                      /* small vertical breathing room */
  .row{ display:grid; grid-template-columns:96px 1fr; gap:16px;
        background:var(--card); border-radius:var(--radius); box-shadow:
    0 0 0 1px rgba(0,0,0,.07),
    var(--shadow);;
        padding:14px; margin-bottom:14px; }
  .thumb{ width:96px; height:96px; border-radius:12px; object-fit:cover; background:#e8eef5; }
  .row h3{ margin:0; font-size:1.35rem; }
  .row .when{ color:var(--muted); font-weight:700; margin:4px 0 2px; }
  .row .where,.row .format{ margin:2px 0; }
  .row .desc{margin-top:8px; display:block; white-space:pre-line; overflow:visible; -webkit-line-clamp:unset; -webkit-box-orient:unset;}
  .row .cta{ margin-top:10px; width:max-content; padding:10px 14px; }
  .agenda .cta { padding: 6px 10px; border-radius: 8px; font-size: .9rem; }
  .sr-only{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; }
  [hidden]{ display:none !important; }
</style>
</head>
<body>

  <!-- heading + tabs aligned to card rail -->
  <div class="widget-shell">
    <div class="rail-margins">
      <h1>Upcoming AIT PD Opportunities</h1>
      <div class="tabs" role="tablist" aria-label="View">
        <button id="tabCards"  class="tab" role="tab" aria-selected="true"  aria-controls="panelCards">Cards</button>
        <button id="tabAgenda" class="tab" role="tab" aria-selected="false" aria-controls="panelAgenda">Agenda</button>
      </div>
    </div>
  </div>

  <!-- CARDS -->
  <section id="panelCards" role="tabpanel" aria-labelledby="tabCards">
    <div class="widget-shell">
      <div class="carousel">
        <button id="prevBtn" class="nav" aria-label="Previous">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="strip" class="strip" role="list"></div>

        <button id="nextBtn" class="nav" aria-label="Next">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </section>

  <!-- AGENDA (same left/right margins as card rail, and its own scroll area) -->
  <section id="panelAgenda" role="tabpanel" aria-labelledby="tabAgenda" hidden>
    <div class="widget-shell">
      <div class="rail-margins">
        <div class="agenda-viewport">
          <div class="agenda-wrap" id="agendaWrap"></div>
        </div>
      </div>
    </div>
  </section>

  <div id="empty" hidden>No upcoming events found.</div>

<script>
/* ========= CONFIG ========= */
const CALENDAR_ID   = 'unkaitcalendar@gmail.com';
const API_KEY       = 'AIzaSyBUJxL5LLxzrzutXCSGBcv28XJX02GhSIU';
const MONTHS_AHEAD  = 3;
const MAX_RESULTS   = 50;
const FALLBACK_IMAGE= 'https://stephanielanik.github.io/pd-events/images/aitevent.jpg';

/* ========= Helpers ========= */
function getRange(){
  const now = new Date(); const end = new Date(); end.setMonth(end.getMonth() + MONTHS_AHEAD);
  return { timeMin: now.toISOString(), timeMax: end.toISOString() };
}
function fmtRange(startISO, endISO, allDay){
  const optsD = { weekday:'short', month:'short', day:'numeric' };
  const optsT = { hour:'numeric', minute:'2-digit' };
  const s = new Date(startISO), e = new Date(endISO || startISO);
  if (allDay){
    const same = s.toDateString() === e.toDateString();
    return same ? s.toLocaleDateString(undefined, optsD)
                : `${s.toLocaleDateString(undefined, optsD)} → ${e.toLocaleDateString(undefined, optsD)}`;
  }else{
    const same = s.toDateString() === e.toDateString();
    const d1 = s.toLocaleDateString(undefined, optsD);
    const t1 = s.toLocaleTimeString(undefined, optsT);
    const t2 = e.toLocaleTimeString(undefined, optsT);
    return same ? `${d1} • ${t1}–${t2}` : `${d1} ${t1} → ${e.toLocaleDateString(undefined, optsD)} ${t2}`;
  }
}
function htmlToText(html){
  const d = document.createElement('div'); d.innerHTML = html || '';
  d.querySelectorAll('style,script').forEach(el => el.remove());
  const text = d.textContent || '';
  return text.replace(/\u00A0/g,' ').replace(/\s+\n/g,"\n").trim();
}
function getTaggedUrlFromEither(descHtml, descText, tag){
  const hm = (descHtml||'').replace(/\u00A0/g,' ').match(new RegExp(tag+'\\s*:\\s*<a[^>]+href="([^"]+)"','i'));
  if (hm?.[1]) { try { new URL(hm[1]); return hm[1]; } catch {} }
  const tm = (descText||'').match(new RegExp(tag+'\\s*:\\s*(https?:\\/\\/\\S+)','i'));
  if (tm?.[1]) { try { new URL(tm[1]); return tm[1]; } catch {} }
  return '';
}
function sanitizeDesc(descText){
  if (!descText) return '';
  return descText.replace(/\s*(BANNER|REGISTER|SIGNUP)\s*:\s*https?:\/\/\S+/gi,'')
                 .replace(/\n{3,}/g,"\n\n")
                 .trim();
}
// Find a Zoom link via tag or by scanning description/location
function findZoomLink(descHtml, descText, location) {
  // 1) Prefer explicit tag: ZOOM: https://...
  const tagged = getTaggedUrlFromEither(descHtml, descText, 'ZOOM');
  if (tagged) return tagged;

  // 2) Otherwise scan for any zoom.us link in html/text/location
  const rx = /https?:\/\/[^\s"'<>]*zoom\.us[^\s"'<>]*/i; // covers /j/..., /my/..., ?pwd=...
  const candidates = [descHtml || '', descText || '', location || ''];
  for (const raw of candidates) {
    const s = String(raw).replace(/\u00A0/g, ' ');
    const m = s.match(rx);
    if (m && m[0]) return m[0];
  }
  return '';
}

// Add ZOOM to the tags we remove from visible description
function sanitizeDesc(descText) {
  if (!descText) return '';
  return descText
    .replace(/\s*(BANNER|REGISTER|ZOOM)\s*:\s*https?:\/\/\S+/gi, '')
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}
function getTimes(ev){
  const s = ev.start?.dateTime || (ev.start?.date ? ev.start.date + 'T00:00:00' : null);
  const e = ev.end?.dateTime   || (ev.end?.date   ? ev.end.date   + 'T00:00:00' : s);
  const allDay = !!ev.start?.date && !!ev.end?.date;
  return { start:s, end:e, allDay };
}

/* ========= Fetch ========= */
async function fetchEvents(){
  const { timeMin, timeMax } = getRange();
  const base = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events`;
  const url  = new URL(base);
  url.searchParams.set('key', API_KEY);
  url.searchParams.set('singleEvents','true');
  url.searchParams.set('orderBy','startTime');
  url.searchParams.set('maxResults', String(MAX_RESULTS));
  url.searchParams.set('timeMin', timeMin);
  url.searchParams.set('timeMax', timeMax);

  const r = await fetch(url.toString());
  if (!r.ok) throw new Error('Google API error ' + r.status);
  const data = await r.json();
  return (data.items || []).filter(ev => ev.status !== 'cancelled');
}

/* ========= Render: Cards ========= */
function renderCards(events){
  const strip = document.getElementById('strip');
  strip.innerHTML = '';

  for (const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);
    const banner   = getTaggedUrlFromEither(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
    const signup   = getTaggedUrlFromEither(descHtml, descText, 'SIGNUP') ||
                     getTaggedUrlFromEither(descHtml, descText, 'REGISTER');
    const descClean= sanitizeDesc(descText);
    const zoom = findZoomLink(descHtml, descText, ev.location);
    
    const card = document.createElement('article');
    card.className = 'card'; card.setAttribute('role','listitem');

    const imgWrap = document.createElement('div'); imgWrap.className='img-wrap';
    const img = document.createElement('img');
    img.src=banner; img.alt=''; img.loading='lazy'; img.referrerPolicy='no-referrer';
    img.onerror=()=>{ img.src=FALLBACK_IMAGE; };
    imgWrap.appendChild(img);

    const c = document.createElement('div'); c.className='content';
    const title = document.createElement('div'); title.className='title'; title.textContent = ev.summary || 'Untitled event';
    const meta  = document.createElement('div'); meta.className='meta'; meta.textContent = when + (ev.location ? ` • ${ev.location}` : '');
    const desc  = document.createElement('div'); desc.className='desc'; desc.textContent = descClean;

    let moreBtn;
    if (descClean.split(/\s+/).length > 24){
      moreBtn = document.createElement('button'); moreBtn.className='more'; moreBtn.type='button';
      moreBtn.textContent='Show more';
      moreBtn.addEventListener('click', ()=>{
        const expanded = desc.classList.toggle('expanded');
        moreBtn.textContent = expanded ? 'Show less' : 'Show more';
      });
    }

    c.append(title, meta, desc);
    if (moreBtn) c.appendChild(moreBtn);

    if (signup){
      const a=document.createElement('a');
      a.className='cta'; a.href=signup; a.target='_blank'; a.rel='noopener'; a.textContent='Sign up';
      c.appendChild(a);
    }
if (zoom) {
  const btnZ = document.createElement('a');
  btnZ.href = zoom; btnZ.target = '_blank'; btnZ.rel = 'noopener';
  btnZ.className = 'cta';
  btnZ.textContent = 'Join on Zoom';
  c.appendChild(btnZ);
}
    card.append(imgWrap, c);
    strip.appendChild(card);
  }

  initRailNav();
}

/* ========= Render: Agenda ========= */
function renderAgenda(events){
  const wrap = document.getElementById('agendaWrap');
  wrap.innerHTML = '';

  for (const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);
    const banner   = getTaggedUrlFromEither(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
    const signup   = getTaggedUrlFromEither(descHtml, descText, 'SIGNUP') ||
                     getTaggedUrlFromEither(descHtml, descText, 'REGISTER');
    const descClean= sanitizeDesc(descText);
    const zoom = findZoomLink(descHtml, descText, ev.location);
    
    const row = document.createElement('article'); row.className='row';

    const thumb=document.createElement('img'); thumb.className='thumb';
    thumb.src=banner; thumb.alt=''; thumb.loading='lazy'; thumb.referrerPolicy='no-referrer';
    thumb.onerror=()=>{ thumb.src=FALLBACK_IMAGE; };

    const body=document.createElement('div');
    const h3=document.createElement('h3'); h3.textContent=ev.summary || 'Untitled event';
    const dw=document.createElement('div'); dw.className='when';   dw.textContent=when;
    const wl=document.createElement('div'); wl.className='where';  if (ev.location) wl.textContent = `Where: ${ev.location}`;
    const fm=document.createElement('div'); fm.className='format';
    const fmtMatch = descText.match(/Format:\s*(.+)/i);
    fm.textContent = 'Format: ' + (fmtMatch?.[1] || 'In Person and/or Zoom');

    const d=document.createElement('div'); d.className='desc'; d.textContent=descClean;

    body.append(h3, dw);
    if (wl.textContent) body.append(wl);
    if (fm.textContent) body.append(fm);
    if (d.textContent)  body.append(d);

    if (signup){
      const a=document.createElement('a'); a.className='cta'; a.href=signup; a.target='_blank'; a.rel='noopener'; a.textContent='Sign up';
      body.appendChild(a);
    }
    if (zoom) {
  const z = document.createElement('a');
  z.href = zoom; z.target = '_blank'; z.rel = 'noopener';
  z.textContent = 'Join on Zoom';
  z.className = 'cta'; // or a smaller link style if you prefer
  details.appendChild(z);
}

    row.append(thumb, body);
    wrap.appendChild(row);
  }
}

/* ========= Carousel arrows ========= */
function initRailNav(){
  const strip   = document.getElementById('strip');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if (!strip || !prevBtn || !nextBtn) return;

  const eps = 1;
  const maxScrollLeft = el => el.scrollWidth - el.clientWidth;

  function updateArrows(){
    const max = maxScrollLeft(strip);
    const sl  = strip.scrollLeft;
    const noOverflow = max <= eps;
    prevBtn.disabled = noOverflow || sl <= eps;
    nextBtn.disabled = noOverflow || (max - sl) <= eps;
  }

  prevBtn.onclick = () => strip.scrollBy({ left: -strip.clientWidth, behavior:'smooth' });
  nextBtn.onclick = () => strip.scrollBy({ left:  strip.clientWidth, behavior:'smooth' });
  strip.addEventListener('scroll', updateArrows, { passive:true });
  window.addEventListener('resize', () => requestAnimationFrame(updateArrows));
  requestAnimationFrame(updateArrows);
}

/* ========= Tabs ========= */
function initTabs(){
  const tabCards  = document.getElementById('tabCards');
  const tabAgenda = document.getElementById('tabAgenda');
  const panelCards  = document.getElementById('panelCards');
  const panelAgenda = document.getElementById('panelAgenda');

  function select(which){
    const showCards = which === 'cards';
    tabCards.setAttribute('aria-selected', String(showCards));
    tabAgenda.setAttribute('aria-selected', String(!showCards));
    panelCards.hidden  = !showCards;
    panelAgenda.hidden = showCards;
    if (showCards) requestAnimationFrame(initRailNav);
  }
  tabCards.addEventListener('click',  ()=>select('cards'));
  tabAgenda.addEventListener('click', ()=>select('agenda'));
}

/* ========= Boot ========= */
(async function boot(){
  try{
    initTabs();
    const events = await fetchEvents();
    if (!events.length){ document.getElementById('empty').hidden = false; return; }
    renderCards(events);
    renderAgenda(events);
  }catch(err){
    const e = document.getElementById('empty');
    e.hidden = false; e.textContent = 'Could not load events. (' + err.message + ')';
    console.error(err);
  }
})();
</script>
</body>
</html>
