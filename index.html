<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upcoming AIT Professional Development</title>

<style>
  :root{
    --brand: #004D86;
    --brand-hover: #0a5ea2;
    --brand-active: #084d86;
    --text: #15202b;
    --muted: #445;
    --bg: transparent; /* keep the host page background */
    --card: #fff;
    --soft: #f2f4f7;
    --radius: 18px;
    --shadow: 0 8px 24px rgba(0,0,0,.08);
    --shadow-md: 0 14px 40px rgba(0,0,0,.12);
  }

  /* Page frame */
  body{
    margin:0;
    padding:24px 16px 36px;
    background:var(--bg);
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  h1{
    font-size: clamp(1.25rem, 1.1rem + 1.1vw, 2rem);
    margin: 0 0 12px;
  }

  /* View toggle */
  .tabs{
    display:flex; gap:10px; margin: 6px 0 18px;
  }
  .tab{
    appearance:none; border:0; border-radius: 999px; padding:10px 14px;
    background: var(--soft); color: var(--text); font-weight: 700; cursor:pointer;
  }
  .tab[aria-selected="true"]{ background: var(--brand); color:#fff; }

  /* Shared card look */
  .card{
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  /* --- CARDS VIEW --- */
  .rail{
    position:relative;
  }
  .strip{
    display:grid;
    grid-auto-flow: column;
    grid-auto-columns: minmax(300px, 360px);
    gap: 18px;
    overflow-x:auto;
    padding: 8px 56px;           /* room for the arrows */
    scroll-snap-type: x mandatory;
  }
  .strip > article{
    scroll-snap-align:start;
  }

  /* Arrow buttons (fixed & accessible) */
  .nav{
    position:absolute; top: 42%;
    width:44px; height:44px; border-radius: 50%;
    border:0; cursor:pointer;
    background: var(--brand); color:#fff; font-size:22px; font-weight: 700;
    display:grid; place-items:center;
    box-shadow: var(--shadow);
    z-index: 2;
  }
  .nav.prev { left: 8px;  }
  .nav.next { right: 8px; }
  .nav:hover{ background: var(--brand-hover); }
  .nav:active{ background: var(--brand-active); }
  .nav[disabled]{
    opacity:.35; pointer-events:none; filter: grayscale(1);
  }

  .img-wrap{ position:relative; aspect-ratio:16 / 9; overflow:hidden;
    border-top-left-radius: var(--radius);
    border-top-right-radius: var(--radius);
    background: #e8eef5;
  }
  .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block; }

  .content{ display:grid; gap: 8px; padding: 14px 16px 16px; }
  .title{ font-weight:800; font-size: 1.6rem; line-height:1.15; }
  .meta { color: var(--muted); font-weight: 700; }
  .desc{
    color:#333;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 5;
    overflow: hidden;
    white-space: pre-line; /* keep \n from calendar */
    line-height: 1.45;
  }
  .desc.expanded{
    -webkit-line-clamp: unset; overflow: visible; max-height:none;
  }
  .more{
    appearance:none; border:0; background:transparent; color:var(--brand);
    font-weight:800; cursor:pointer; margin-top: -4px; width:fit-content;
  }

  .cta{
    display:inline-block; text-decoration:none; text-align:center;
    margin-top: 10px; padding: 12px 14px; border-radius: 12px;
    background: var(--brand); color:#fff; font-weight: 800;
  }
  .cta:hover{ background: var(--brand-hover); }
  .cta:active{ background: var(--brand-active); }

  /* bottom fade rail */
  .rail-fade{
    height:10px; border-radius:999px; margin:12px 66px 0;
    background: linear-gradient(90deg, transparent, #d6dce3 20%, #d6dce3 80%, transparent);
  }

  /* --- AGENDA VIEW --- */
  .agenda-wrap{
    padding: 10px 12px;          /* prevents any shadow clipping */
  }
  .row{
    display:grid; grid-template-columns: 96px 1fr; gap:16px;
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    padding: 14px; margin-bottom: 14px;
  }
  .thumb{ width:96px; height:96px; border-radius: 12px; object-fit:cover; background:#e8eef5; }
  .row h3{ margin:0; font-size: 1.35rem; }
  .row .when{ color: var(--muted); font-weight:700; margin: 4px 0 2px; }
  .row .where, .row .format{ margin:2px 0; }
  .row .desc{ margin-top:8px; }
  .row .cta{ margin-top: 10px; width: max-content; padding: 10px 14px; }

  /* utils */
  .sr-only{ position:absolute; width:1px; height:1px; overflow:hidden; clip: rect(0,0,0,0); white-space:nowrap; }
  [hidden]{ display:none !important; }
</style>
</head>
<body>

  <h1>Upcoming AIT Professional Development</h1>

  <div class="tabs" role="tablist" aria-label="View">
    <button id="tabCards"  class="tab" role="tab" aria-selected="true"  aria-controls="panelCards">Cards</button>
    <button id="tabAgenda" class="tab" role="tab" aria-selected="false" aria-controls="panelAgenda">Agenda</button>
  </div>

  <!-- Cards panel -->
  <section id="panelCards" role="tabpanel" aria-labelledby="tabCards">
    <div class="rail" id="rail">
      <button class="nav prev" id="prevBtn" aria-label="Previous">‹</button>
      <div id="strip" class="strip" role="list" aria-label="Upcoming events (cards)"></div>
      <button class="nav next" id="nextBtn" aria-label="Next">›</button>
    </div>
    <div class="rail-fade" aria-hidden="true"></div>
  </section>

  <!-- Agenda panel -->
  <section id="panelAgenda" role="tabpanel" aria-labelledby="tabAgenda" hidden>
    <div class="agenda-wrap" id="agendaWrap"></div>
  </section>

  <div id="empty" hidden>No upcoming events found.</div>

<script>
/* ====== CONFIG – fill these in ====== */
const CALENDAR_ID = 'unkaitcalendar@gmail.com';
const API_KEY     = 'AIzaSyBUJxL5LLxzrzutXCSGBcv28XJX02GhSIU';
const MONTHS_AHEAD = 3;
const MAX_RESULTS  = 50;
const FALLBACK_IMAGE = 'https://stephanielanik.github.io/pd-events/images/aitevent.jpg';

/* ====== Helpers ====== */
function getRange(){
  const now = new Date();
  const end = new Date(); end.setMonth(end.getMonth() + MONTHS_AHEAD);
  return { timeMin: now.toISOString(), timeMax: end.toISOString() };
}
function fmtRange(startISO, endISO, allDay){
  const optsD = { weekday:'short', month:'short', day:'numeric' };
  const optsT = { hour:'numeric', minute:'2-digit' };
  const s = new Date(startISO);
  const e = new Date(endISO || startISO);
  if (allDay) {
    const same = s.toDateString() === e.toDateString();
    return same ? s.toLocaleDateString(undefined, optsD)
                : `${s.toLocaleDateString(undefined, optsD)} → ${e.toLocaleDateString(undefined, optsD)}`;
  } else {
    const same = s.toDateString() === e.toDateString();
    const d1 = s.toLocaleDateString(undefined, optsD);
    const t1 = s.toLocaleTimeString(undefined, optsT);
    const t2 = e.toLocaleTimeString(undefined, optsT);
    return same ? `${d1} • ${t1}–${t2}`
                : `${d1} ${t1} → ${e.toLocaleDateString(undefined, optsD)} ${t2}`;
  }
}
function htmlToText(html){
  const d = document.createElement('div');
  d.innerHTML = html || '';
  d.querySelectorAll('style,script').forEach(el => el.remove());
  const text = d.textContent || '';
  return text.replace(/\u00A0/g,' ').replace(/\s+\n/g,"\n").trim();
}
// Pull a URL from either HTML form 'TAG: <a href="...">' or plain text 'TAG: https://...'
function getTaggedUrlFromEither(descHtml, descText, tag){
  const htmlRe = new RegExp(tag + '\\s*:\\s*<a[^>]+href="([^"]+)"','i');
  const hm = (descHtml || '').replace(/\u00A0/g,' ').match(htmlRe);
  if (hm?.[1]) { try { new URL(hm[1]); return hm[1]; } catch{} }

  const txtRe  = new RegExp(tag + '\\s*:\\s*(https?:\\/\\/\\S+)','i');
  const tm = (descText || '').match(txtRe);
  if (tm?.[1]) { try { new URL(tm[1]); return tm[1]; } catch{} }
  return '';
}
// Remove tag lines from visible description & tidy spacing
function sanitizeDesc(descText){
  if (!descText) return '';
  return descText
    .replace(/\s*(BANNER|REGISTER|SIGNUP)\s*:\s*https?:\/\/\S+/gi,'')
    .replace(/\n{3,}/g,"\n\n")
    .trim();
}

/* ====== Fetch ====== */
async function fetchEvents(){
  const { timeMin, timeMax } = getRange();
  const base = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events`;
  const url = new URL(base);
  url.searchParams.set('key', API_KEY);
  url.searchParams.set('singleEvents','true');
  url.searchParams.set('orderBy','startTime');
  url.searchParams.set('maxResults', String(MAX_RESULTS));
  url.searchParams.set('timeMin', timeMin);
  url.searchParams.set('timeMax', timeMax);

  const r = await fetch(url.toString());
  if(!r.ok) throw new Error('Google API error ' + r.status);
  const data = await r.json();
  return (data.items || []).filter(ev => ev.status !== 'cancelled');
}

function getTimes(ev){
  const s = ev.start?.dateTime || (ev.start?.date ? ev.start.date + 'T00:00:00' : null);
  const e = ev.end?.dateTime   || (ev.end?.date   ? ev.end.date   + 'T00:00:00' : s);
  const allDay = !!ev.start?.date && !!ev.end?.date;
  return { start:s, end:e, allDay };
}

/* ====== Render: Cards ====== */
function renderCards(events){
  const strip = document.getElementById('strip');
  strip.innerHTML = '';

  for(const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);

    const banner = getTaggedUrlFromEither(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
    // Accept SIGNUP: or REGISTER:
    const signup = getTaggedUrlFromEither(descHtml, descText, 'SIGNUP') ||
                   getTaggedUrlFromEither(descHtml, descText, 'REGISTER');
    const descClean = sanitizeDesc(descText);

    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('role','listitem');

    // image
    const imgWrap = document.createElement('div');
    imgWrap.className = 'img-wrap';
    const img = document.createElement('img');
    img.src = banner; img.alt = '';
    img.loading = 'lazy'; img.referrerPolicy = 'no-referrer';
    img.onerror = () => { img.src = FALLBACK_IMAGE; };
    imgWrap.appendChild(img);

    // content
    const c = document.createElement('div');
    c.className = 'content';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = ev.summary || 'Untitled event';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = when + (ev.location ? ` • ${ev.location}` : '');

    const desc = document.createElement('div');
    desc.className = 'desc';
    desc.textContent = descClean;

    let moreBtn;
    if (descClean.split(/\s+/).length > 24) { // roughly needs a "show more"
      moreBtn = document.createElement('button');
      moreBtn.className = 'more';
      moreBtn.type = 'button';
      moreBtn.textContent = 'Show more';
      moreBtn.addEventListener('click', () => {
        const expanded = desc.classList.toggle('expanded');
        moreBtn.textContent = expanded ? 'Show less' : 'Show more';
      });
    }

    c.append(title, meta, desc);
    if (moreBtn) c.appendChild(moreBtn);

    if (signup){
      const a = document.createElement('a');
      a.className = 'cta'; a.href = signup; a.target = '_blank'; a.rel = 'noopener';
      a.textContent = 'Sign up';
      c.appendChild(a);
    }

    card.append(imgWrap, c);
    strip.appendChild(card);
  }

  initRailNav(); // (re)wire arrows after cards render
}

/* ====== Render: Agenda ====== */
function renderAgenda(events){
  const wrap = document.getElementById('agendaWrap');
  wrap.innerHTML = '';

  for(const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);

    const banner = getTaggedUrlFromEither(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
    const signup = getTaggedUrlFromEither(descHtml, descText, 'SIGNUP') ||
                   getTaggedUrlFromEither(descHtml, descText, 'REGISTER');
    const descClean = sanitizeDesc(descText);

    const row = document.createElement('article');
    row.className = 'row';

    const thumb = document.createElement('img');
    thumb.className = 'thumb';
    thumb.src = banner; thumb.alt='';
    thumb.loading = 'lazy'; thumb.referrerPolicy = 'no-referrer';
    thumb.onerror = () => { thumb.src = FALLBACK_IMAGE; };

    const body = document.createElement('div');
    const h3 = document.createElement('h3'); h3.textContent = ev.summary || 'Untitled event';
    const dw = document.createElement('div'); dw.className = 'when';   dw.textContent   = when;
    const wl = document.createElement('div'); wl.className = 'where';  wl.textContent   = ev.location ? `Where: ${ev.location}` : '';
    const fm = document.createElement('div'); fm.className = 'format'; fm.textContent   = 'Format: ' + (descText.match(/Format:\s*(.+)/i)?.[1] ?? 'In Person and/or Zoom');

    const d = document.createElement('div');
    d.className = 'desc'; d.textContent = descClean;

    body.append(h3, dw);
    if (wl.textContent) body.append(wl);
    if (fm.textContent) body.append(fm);
    if (d.textContent)  body.append(d);

    if (signup){
      const a = document.createElement('a');
      a.className = 'cta'; a.href = signup; a.target='_blank'; a.rel='noopener';
      a.textContent = 'Sign up';
      body.appendChild(a);
    }

    row.append(thumb, body);
    wrap.appendChild(row);
  }
}

/* ====== Rail navigation (arrows) ====== */
function initRailNav(){
  const strip   = document.getElementById('strip');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if (!strip || !prevBtn || !nextBtn) return;

  const eps = 1; // tolerance for sub-pixel math
  const maxScrollLeft = el => el.scrollWidth - el.clientWidth;

  function updateArrows(){
    const max = maxScrollLeft(strip);
    const sl  = strip.scrollLeft;

    const noOverflow = max <= eps;
    prevBtn.disabled = noOverflow || sl <= eps;
    nextBtn.disabled = noOverflow || (max - sl) <= eps;
  }

  prevBtn.onclick = () => strip.scrollBy({ left: -strip.clientWidth, behavior:'smooth' });
  nextBtn.onclick = () => strip.scrollBy({ left:  strip.clientWidth, behavior:'smooth' });

  strip.addEventListener('scroll', updateArrows, { passive:true });
  window.addEventListener('resize', () => requestAnimationFrame(updateArrows));

  requestAnimationFrame(updateArrows); // initial state
}

/* ====== Tabs ====== */
function initTabs(){
  const tabCards  = document.getElementById('tabCards');
  const tabAgenda = document.getElementById('tabAgenda');
  const panelCards  = document.getElementById('panelCards');
  const panelAgenda = document.getElementById('panelAgenda');

  function select(which){
    const cards = which === 'cards';
    tabCards.setAttribute('aria-selected', String(cards));
    tabAgenda.setAttribute('aria-selected', String(!cards));
    panelCards.hidden  = !cards;
    panelAgenda.hidden = cards;
    if (cards) requestAnimationFrame(initRailNav); // ensure arrows reflect current width
  }

  tabCards.addEventListener('click',  () => select('cards'));
  tabAgenda.addEventListener('click', () => select('agenda'));
}

/* ====== Boot ====== */
(async function boot(){
  try{
    initTabs();
    const events = await fetchEvents();
    if (!events.length){
      document.getElementById('empty').hidden = false;
      return;
    }
    renderCards(events);
    renderAgenda(events);
  }catch(err){
    document.getElementById('empty').hidden = false;
    document.getElementById('empty').textContent = 'Could not load events. (' + err.message + ')';
    console.error(err);
  }
})();
</script>
</body>
</html>
