<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upcoming AIT Professional Development</title>

<style>
  :root{
    --brand:#004D86; --brand-hover:#0a5ea2; --brand-active:#084d86;
    --text:#15202b; --muted:#445;
    --bg:transparent;
    --card:#fff; --soft:#f2f4f7;
    --radius:18px;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --shadow-md:0 14px 40px rgba(0,0,0,.12);
    --gap:20px; --nav:48px;
    --rail-pad: calc(var(--nav) + 8px);
  }

  body{ margin:0; padding:24px 16px 36px; background:var(--bg); color:var(--text);
        font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

  .widget-shell{ max-width:1200px; margin:0 auto; }
  .rail-margins{ padding-left:var(--rail-pad); padding-right:var(--rail-pad); }
  h1{ font-size:clamp(1.25rem,1.1rem + 1.1vw,2rem); margin:0 0 12px; }

  .tabs{ display:flex; gap:10px; margin:6px 0 18px; }
  .tab{ appearance:none; border:0; border-radius:999px; padding:10px 14px;
        background:var(--soft); color:var(--text); font-weight:700; cursor:pointer; }
  .tab[aria-selected="true"]{ background:var(--brand); color:#fff; }

  .carousel{ position:relative; padding:0 var(--rail-pad); }
 .strip{
  display:grid;
  position:relative;
  grid-auto-flow:column;
  grid-auto-columns:minmax(290px, calc((min(1200px, 100%) - (var(--gap)*2)) / 3));
  gap:var(--gap);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding-left:var(--gap);
  padding-bottom:12px;
  scroll-padding-left:var(--gap);
  padding-right:calc(var(--gap) * .5);
  scroll-padding-right:calc(var(--gap) * .5);
}
  #empty{
  position: absolute;
  inset: 0;                     /* stretch to edges of the strip */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  text-align: center;
  color: #445;
  pointer-events: none;         /* clicks pass through when shown */
}
  .strip > article:first-child{ scroll-margin-left: var(--gap); }

  .card{ background:var(--card); border-radius:var(--radius); box-shadow:0 0 0 1px rgba(0,0,0,.07),var(--shadow); position: relative;
  box-sizing: border-box; min-width: 0;}
  .card:hover,
 .card:focus-within{z-index: 5;               /* lift the active/hovered card above neighbors */
}
 .presenter{
  font-weight: 600;
  color:#004D86;         /* UNK blue */
  margin-top:2px;
  margin-bottom:6px;
}
  .img-wrap{ position:relative; aspect-ratio:16/9; overflow:hidden;
             border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
             background:#e8eef5; }
  .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block; }
  .content{ display:grid; gap:8px; padding:14px 16px 16px; }
  .title{ font-weight:800; font-size:1.6rem; line-height:1.15; }
  .meta{ color:var(--muted); font-weight:700; }
  .card .desc{ color:#333; display:-webkit-box; -webkit-box-orient:vertical; min-width: 0; overflow-wrap: anywhere; -webkit-line-clamp:5;
         overflow:hidden; white-space:pre-line; line-height:1.45; }
  .desc.expanded{ -webkit-line-clamp:unset; overflow:visible; max-height:none; }
  .more{ appearance:none; border:0; background:transparent; color:var(--brand);
         font-weight:800; cursor:pointer; margin-top:-4px; width:fit-content; }

  .cta{ display:inline-block; text-decoration:none; text-align:center;
        margin-top:10px; padding:12px 14px; border-radius:12px;
        background:var(--brand); color:#fff; font-weight:800; }
  .cta:hover{ background:var(--brand-hover); }
  .cta:active{ background:var(--brand-active); }

  .nav{ position:absolute; top:50%; transform:translateY(-50%); width:var(--nav); height:var(--nav);
        border:0; border-radius:999px; display:grid; place-items:center;
        background:var(--brand); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); cursor:pointer; }
  #prevBtn{ left:8px; }  #nextBtn{ right:8px; }
  .nav:hover{ background:var(--brand-hover); } .nav:active{ background:var(--brand-active); }
  .nav[disabled]{ background:#d5dbe3; color:#fff; cursor:not-allowed; opacity:.85; }
.carousel { position: relative; }  /* already present in your file; harmless to repeat */
.empty-overlay{position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 16px; text-align: center; color: #445; pointer-events: none; font-weight: 600;
}
  .agenda-viewport{ max-height:70vh; overflow:auto; padding:0 var(--gap); box-sizing:border-box; }
  .agenda-wrap{ padding-top:6px; padding-bottom:12px; }
  .row{position: relative;               /* <-- add this line */
  display:grid; grid-template-columns:96px 1fr; gap:16px;
  background:var(--card); border-radius:var(--radius);
  box-shadow:0 0 0 1px rgba(0,0,0,.07), var(--shadow);
  padding:14px; margin-bottom:14px;
}
  .thumb{ width:96px; height:96px; border-radius:12px; object-fit:cover; background:#e8eef5; }
  .row h3{ margin:0; font-size:1.35rem; }
  .row .when{ color:var(--muted); font-weight:700; margin:4px 0 2px; }
  .row .where{ margin:2px 0; }
  .row .desc{ margin-top:8px; display:block; white-space:pre-line; overflow:visible; -webkit-line-clamp:unset; -webkit-box-orient:unset; }
  .agenda .cta{ padding:6px 10px; border-radius:8px; font-size:.9rem; }

  .sr-only{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; }
  [hidden]{ display:none !important; }

  /* --- Add-to-Calendar UI --- */
  .addcal-btn{
    position:absolute; top:8px; right:8px; width:32px; height:32px;
    border-radius:999px; background:rgba(255,255,255,.92);
    display:grid; place-items:center; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 8px 20px rgba(0,0,0,.12); cursor:pointer;
    backdrop-filter:saturate(1.2) blur(6px);
  }
  .addcal-btn img{ width:18px; height:18px; display:block; }
  .addcal-menu{
    position:absolute; top:44px; right:8px; background:#fff; z-index:10;
    border:1px solid rgba(0,0,0,.12); border-radius:12px; box-shadow:var(--shadow-md);
    padding:6px; min-width:200px;
  }
  .addcal-menu a{
    display:block; padding:10px 12px; text-decoration:none; color:#004D86; font-weight:800;
    border-radius:8px;
  }
  .addcal-menu a:hover{ background:#f2f6fb; }
  .hide{ display:none !important; }
</style>
</head>
<body>

  <div class="widget-shell">
    <div class="rail-margins">
      <h1>Upcoming Events</h1>
      <div class="tabs" role="tablist" aria-label="View">
        <button id="tabCards"  class="tab" role="tab" aria-selected="true"  aria-controls="panelCards">Cards</button>
        <button id="tabAgenda" class="tab" role="tab" aria-selected="false" aria-controls="panelAgenda">Agenda</button>
      </div>
    </div>
  </div>

  <section id="panelCards" role="tabpanel" aria-labelledby="tabCards">
    <div class="widget-shell">
      <div class="carousel">
        <button id="prevBtn" class="nav" aria-label="Previous">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="strip" class="strip" role="list"></div>

        <button id="nextBtn" class="nav" aria-label="Next">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div id="emptyCards" class="empty-overlay" hidden>No upcoming events found.</div>
      </div>
    </div>
  </section>

  <section id="panelAgenda" role="tabpanel" aria-labelledby="tabAgenda" hidden>
    <div class="widget-shell">
      <div class="rail-margins">
        <div class="agenda-viewport">
          <div class="agenda-wrap" id="agendaWrap"></div>
        </div>
      </div>
    </div>
  </section>

  <div id="empty" hidden>No upcoming events found.</div>

<script>
/* ========= CONFIG ========= */
const CALENDAR_ID   = 'unkaitcalendar@gmail.com';
const API_KEY       = 'AIzaSyBUJxL5LLxzrzutXCSGBcv28XJX02GhSIU';
const MONTHS_AHEAD  = 3;
const MAX_RESULTS   = 50;
const FALLBACK_IMAGE= 'https://stephanielanik.github.io/pd-events/images/aitevent.jpg';
const ICON_URL      = 'https://stephanielanik.github.io/pd-events/images/calendar-plus-duotone-regular-full.svg';

/* ========= Helpers ========= */
function getRange(){
  const now = new Date(); const end = new Date(); end.setMonth(end.getMonth() + MONTHS_AHEAD);
  return { timeMin: now.toISOString(), timeMax: end.toISOString() };
}
function fmtRange(startISO, endISO, allDay){
  const optsD = { weekday:'short', month:'short', day:'numeric' };
  const optsT = { hour:'numeric', minute:'2-digit' };
  const s = new Date(startISO), e = new Date(endISO || startISO);
  if (allDay){
    const same = s.toDateString() === e.toDateString();
    return same ? s.toLocaleDateString(undefined, optsD)
                : `${s.toLocaleDateString(undefined, optsD)} • ${e.toLocaleDateString(undefined, optsD)}`;
  }else{
    const same = s.toDateString() === e.toDateString();
    const d1 = s.toLocaleDateString(undefined, optsD);
    const t1 = s.toLocaleTimeString(undefined, optsT);
    const t2 = e.toLocaleTimeString(undefined, optsT);
    return same ? `${d1} • ${t1}–${t2}` : `${d1} ${t1} → ${e.toLocaleDateString(undefined, optsD)} ${t2}`;
  }
}
function htmlToText(html) {
  const d = document.createElement('div');
  d.innerHTML = html || '';
  d.querySelectorAll('style,script').forEach(el => el.remove());
  return (d.textContent || '')
    .replace(/\u00A0/g, ' ')
    .replace(/[ \t]+\n/g, '\n')
    .trim();
}
function getTagUrl(descHtml, descText, tag) {
  const normHtml = (descHtml || '').replace(/\u00A0/g, ' ');
  const hm = normHtml.match(new RegExp(tag + '\\s*:\\s*<a[^>]+href="([^"]+)"', 'i'));
  if (hm && hm[1]) return hm[1];
  const tm = (descText || '').match(new RegExp(tag + '\\s*:\\s*(https?:\\/\\/\\S+)', 'i'));
  return tm ? tm[1] : '';
}
 function stripTags(descText){
  return (descText || '')
    .replace(/\u00A0/g, ' ')
    .replace(/\s*(BANNER|SIGNUP|REGISTER|ZOOM)\s*:\s*https?:\/\/\S+/gi, '')
    .replace(/\s*(BANNER|SIGNUP|REGISTER|ZOOM)\s*:\s*<a[^>]+href="[^"]+"[^>]*>[^<]*<\/a>/gi, '')
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}
  // If the first non-empty line is **something**, pull it out as "presenter"
function extractPresenter(text){
  if(!text) return { presenter:'', body:'' };
  const lines = text.split(/\r?\n/);
  // find first non-empty line index
  let i = 0;
  while(i < lines.length && !lines[i].trim()) i++;
  if(i >= lines.length) return { presenter:'', body: text.trim() };

  const m = lines[i].trim().match(/^\*\*(.+?)\*\*$/);
  if(m){
    const presenter = m[1].trim();
    // remove that line and return the rest
    const rest = [...lines.slice(0,i), ...lines.slice(i+1)].join('\n').replace(/\n{3,}/g, '\n\n').trim();
    return { presenter, body: rest };
  }
  return { presenter:'', body: text.trim() };
}
function findZoomLink(descHtml, descText, location) {
  const tagged = getTagUrl(descHtml, descText, 'ZOOM');
  if (tagged) return tagged;
  const rx = /https?:\/\/[^\s"'<>]*zoom\.us[^\s"'<>]*/i;
  const candidates = [descHtml || '', descText || '', location || ''];
  for (const raw of candidates) {
    const s = String(raw).replace(/\u00A0/g, ' ');
    const m = s.match(rx);
    if (m && m[0]) return m[0];
  }
  return '';
}
function sanitizeDesc(descText){
  return stripTags(descText);
}
function getTimes(ev){
  const s = ev.start?.dateTime || (ev.start?.date ? ev.start.date + 'T00:00:00' : null);
  const e = ev.end?.dateTime   || (ev.end?.date   ? ev.end.date   + 'T00:00:00' : s);
  const allDay = !!ev.start?.date && !!ev.end?.date;
  return { start:s, end:e, allDay };
}
function sameYMD(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function fmtDate(d){
  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}
function fmtTime(d){
  return d.toLocaleTimeString(undefined, { hour:'numeric', minute:'2-digit' });
}

function fmtRange(startISO, endISO, allDay){
  const s = new Date(startISO);
  let e = new Date(endISO);

  if (allDay){
    // Google/Outlook use exclusive end date for all-day; back up by 1s
    if (e.getHours()===0 && e.getMinutes()===0 && e.getSeconds()===0){
      e = new Date(e.getTime() - 1000);
    }
    return sameYMD(s,e) ? fmtDate(s) : `${fmtDate(s)} – ${fmtDate(e)}`;
  }

  if (sameYMD(s,e)){
    return `${fmtDate(s)} · ${fmtTime(s)}–${fmtTime(e)}`;
  }
  return `${fmtDate(s)} ${fmtTime(s)} – ${fmtDate(e)} ${fmtTime(e)}`;
}
/* === Add-to-calendar helpers === */
function pad(n){ return String(n).padStart(2,'0'); }
function toICSDate(iso){
  const d = new Date(iso);
  return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate()) +
         'T' + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';
}
function toGoogleDatePart(iso, allDay){
  const d = new Date(iso);
  if (allDay){
    return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate());
  }
  return toICSDate(iso);
}
function makeICSHref({title, desc, location, startISO, endISO, allDay, uid}){
  const lines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//AIT PD//EN',
    'CALSCALE:GREGORIAN',
    'BEGIN:VEVENT',
    `UID:${uid || (startISO + '@ait')}`,
    `DTSTAMP:${toICSDate(new Date().toISOString())}`,
    allDay
      ? `DTSTART;VALUE=DATE:${toGoogleDatePart(startISO,true)}`
      : `DTSTART:${toICSDate(startISO)}`,
    allDay
      ? `DTEND;VALUE=DATE:${toGoogleDatePart(endISO,true)}`
      : `DTEND:${toICSDate(endISO)}`,
    `SUMMARY:${(title||'').replace(/\r?\n/g,' ')}`,
    location ? `LOCATION:${location.replace(/\r?\n/g,' ')}` : '',
    `DESCRIPTION:${(desc||'').replace(/\r?\n/g,' ')}`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');
  return 'data:text/calendar;charset=utf-8,' + encodeURIComponent(lines);
}
function makeGoogleHref({title, desc, location, startISO, endISO, allDay}){
  const dates = `${toGoogleDatePart(startISO,allDay)}/${toGoogleDatePart(endISO,allDay)}`;
  const u = new URL('https://calendar.google.com/calendar/render');
  u.searchParams.set('action','TEMPLATE');
  u.searchParams.set('text', title || '');
  u.searchParams.set('dates', dates);
  if (desc) u.searchParams.set('details', desc);
  if (location) u.searchParams.set('location', location);
  u.searchParams.set('sf','true'); u.searchParams.set('output','xml');
  return u.toString();
}
function makeOutlookWebHref({title, desc, location, startISO, endISO}){
  const u = new URL('https://outlook.live.com/calendar/0/action/compose');
  u.searchParams.set('rru','addevent');
  u.searchParams.set('subject', title || '');
  u.searchParams.set('startdt', startISO);
  u.searchParams.set('enddt', endISO);
  if (location) u.searchParams.set('location', location);
  if (desc) u.searchParams.set('body', desc);
  return u.toString();
}
// Show/hide the empty overlay and disable/enable arrows in Cards view
function setCardsEmptyState(isEmpty){
  const empty = document.getElementById('emptyCards');
  const prev  = document.getElementById('prevBtn');
  const next  = document.getElementById('nextBtn');
  if (!empty || !prev || !next) return;

  if (isEmpty){
    empty.hidden = false;
    prev.setAttribute('disabled','');
    next.setAttribute('disabled','');
    prev.setAttribute('aria-disabled','true');
    next.setAttribute('aria-disabled','true');
  }else{
    empty.hidden = true;
    prev.removeAttribute('disabled');
    next.removeAttribute('disabled');
    prev.removeAttribute('aria-disabled');
    next.removeAttribute('aria-disabled');
  }
}
/* ========= Fetch ========= */
async function fetchEvents(){
  const { timeMin, timeMax } = getRange();
  const base = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events`;
  const url  = new URL(base);
  url.searchParams.set('key', API_KEY);
  url.searchParams.set('singleEvents','true');
  url.searchParams.set('orderBy','startTime');
  url.searchParams.set('maxResults', String(MAX_RESULTS));
  url.searchParams.set('timeMin', timeMin);
  url.searchParams.set('timeMax', timeMax);

  const r = await fetch(url.toString());
  if (!r.ok) throw new Error('Google API error ' + r.status);
  const data = await r.json();
  return (data.items || []).filter(ev => ev.status !== 'cancelled');
}

/* ========= Render: Cards ========= */
function renderCards(events){
  const strip = document.getElementById('strip');
  if (!strip) return;

  // Clear the strip
  strip.innerHTML = '';

  // If no events, show overlay + disable arrows and stop
  if (!events || !events.length){
    setCardsEmptyState(true);
    return;
  }

  // There are events: hide overlay + enable arrows
  setCardsEmptyState(false);

  for (const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);

    const banner  = getTagUrl(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
    const zoomUrl = getTagUrl(descHtml, descText, 'ZOOM');
    const isWebinar = /zoom\.us\/webinar\//i.test(zoomUrl);
    const signup = getTagUrl(descHtml, descText, 'SIGNUP') || (isWebinar ? zoomUrl : '');
    const descClean = stripTags(descText);
    const { presenter, body: descBody } = extractPresenter(stripTags(descText));
    const zoom     = findZoomLink(descHtml, descText, ev.location);

    const card = document.createElement('article');
    card.className = 'card'; card.setAttribute('role','listitem');

    const imgWrap = document.createElement('div'); imgWrap.className='img-wrap';
    const img = document.createElement('img');
    img.src=banner; img.alt=''; img.loading='lazy'; img.referrerPolicy='no-referrer';
    img.onerror=()=>{ img.src=FALLBACK_IMAGE; };
    imgWrap.appendChild(img);

    /* --- Add-to-Calendar button + menu --- */
    const addBtn = document.createElement('button');
    addBtn.className = 'addcal-btn'; addBtn.type='button'; addBtn.title='Add to calendar';
    const icon = document.createElement('img');
    icon.src = ICON_URL; icon.alt = '';
    addBtn.appendChild(icon);

    const menu = document.createElement('div');
    menu.className = 'addcal-menu hide';
    const payload = {
      title: ev.summary || 'Untitled event',
      desc:  descClean,
      location: ev.location || '',
      startISO: start, endISO: end, allDay
    };
    const aGoogle  = document.createElement('a'); aGoogle.textContent  = 'Google Calendar';
    aGoogle.href   = makeGoogleHref(payload);  aGoogle.target='_blank'; aGoogle.rel='noopener';

    const aOutlook = document.createElement('a'); aOutlook.textContent = 'Outlook (web)';
    aOutlook.href  = makeOutlookWebHref(payload); aOutlook.target='_blank'; aOutlook.rel='noopener';

    const aICS     = document.createElement('a'); aICS.textContent     = 'Apple / .ics';
    aICS.href      = makeICSHref({...payload, uid: ev.iCalUID || ev.id});
    aICS.download  = (payload.title.replace(/[^\w\- ]+/g,'').trim() || 'event') + '.ics';

    menu.append(aGoogle, aOutlook, aICS);

    function closeMenus(){ menu.classList.add('hide'); }
    addBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hide'); });
    document.addEventListener('click', closeMenus);
    imgWrap.append(addBtn, menu);

    const c = document.createElement('div'); c.className='content';
    const title = document.createElement('div'); title.className='title'; title.textContent = ev.summary || 'Untitled event';
    const meta  = document.createElement('div'); meta.className='meta'; meta.textContent = when + (ev.location ? ` • ${ev.location}` : '');
    if (presenter) {
  const pres = document.createElement('div');
  pres.className = 'presenter';
  pres.textContent = presenter; // shows exactly what's between ** **
  c.appendChild(pres);
}
    const desc  = document.createElement('div'); desc.className='desc'; desc.textContent = descBody;

    let moreBtn;
    if (descClean.split(/\s+/).length > 24){
      moreBtn = document.createElement('button'); moreBtn.className='more'; moreBtn.type='button';
      moreBtn.textContent='Show more';
      moreBtn.addEventListener('click', ()=>{
        const expanded = desc.classList.toggle('expanded');
        moreBtn.textContent = expanded ? 'Show less' : 'Show more';
      });
    }

    c.append(title, meta, desc);
    if (moreBtn) c.appendChild(moreBtn);

   // === CTA buttons (keep only this block) ===
if (zoomUrl && !isWebinar) {
  makeCta('Join on Zoom', zoomUrl);
} else if (signup) {
  makeCta('Sign up', signup);
}

function makeCta(label, href) {
  const a = document.createElement('a');
  a.className = 'cta';
  a.href = href;
  a.target = '_blank';
  a.rel = 'noopener';
  a.textContent = label;
  c.appendChild(a);
}
    card.append(imgWrap, c);
    strip.appendChild(card);
  }

  initRailNav();
}

/* ========= Render: Agenda (location inline) ========= */
function renderAgenda(events){
  const wrap = document.getElementById('agendaWrap');
  wrap.innerHTML = '';

  for (const ev of events){
    const { start, end, allDay } = getTimes(ev);
    const when = fmtRange(start, end, allDay);

    const descHtml = ev.description || '';
    const descText = htmlToText(descHtml);
    const banner    = getTagUrl(descHtml, descText, 'BANNER') || FALLBACK_IMAGE;
const zoomUrl   = getTagUrl(descHtml, descText, 'ZOOM');
const isWebinar = /zoom\.us\/webinar\//i.test(zoomUrl);
const signup    = getTagUrl(descHtml, descText, 'SIGNUP') || (isWebinar ? zoomUrl : '');
const { presenter, body: descBody } = extractPresenter(stripTags(descText));

    const row = document.createElement('article'); 
    row.className='row';

    // thumb
    const thumb=document.createElement('img'); 
    thumb.className='thumb';
    thumb.src=banner; thumb.alt=''; thumb.loading='lazy'; thumb.referrerPolicy='no-referrer';
    thumb.onerror=()=>{ thumb.src=FALLBACK_IMAGE; };

    // body
    const body=document.createElement('div');
    const h3=document.createElement('h3'); h3.textContent=ev.summary || 'Untitled event';

    // date/time + location inline
    const dw=document.createElement('div'); 
    dw.className='when';
    dw.textContent = when + (ev.location ? ` • ${ev.location}` : '');
if (presenter) {
  const pres = document.createElement('div');
  pres.className = 'presenter';
  pres.textContent = presenter;
  body.appendChild(pres);    // <-- append to the agenda body container
}
    // description (keeps "Format:" if author included it in the body)
    const d=document.createElement('div'); 
    d.className='desc'; 
    d.textContent=descBody;

    body.append(h3, dw);
    if (d.textContent) body.appendChild(d);

 if (zoomUrl && !isWebinar) {
  addAgendaCta(body, 'Join on Zoom', zoomUrl);
} else if (signup) {
  addAgendaCta(body, 'Sign up', signup);
}

function addAgendaCta(container, label, href){
  const a = document.createElement('a');
  a.className = 'cta';
  a.href = href; a.target = '_blank'; a.rel = 'noopener';
  a.textContent = label;
  container.appendChild(a);
}

    // --- Add-to-calendar (agenda) ---
    const addBtn = document.createElement('button');
    addBtn.className = 'addcal-btn'; addBtn.type='button'; addBtn.title='Add to calendar';
    const icon = document.createElement('img');
    icon.src = ICON_URL; icon.alt = '';
    addBtn.appendChild(icon);

    const menu = document.createElement('div');
    menu.className = 'addcal-menu hide';

    const payload = {
  title: ev.summary || 'Untitled event',
  desc:  descBody,           // use the presenter-stripped description you already computed
  location: ev.location || '',
  startISO: start, endISO: end, allDay
};
    const aGoogle  = document.createElement('a'); aGoogle.textContent  = 'Google Calendar';
    aGoogle.href   = makeGoogleHref(payload);  aGoogle.target='_blank'; aGoogle.rel='noopener';

    const aOutlook = document.createElement('a'); aOutlook.textContent = 'Outlook (web)';
    aOutlook.href  = makeOutlookWebHref(payload); aOutlook.target='_blank'; aOutlook.rel='noopener';

    const aICS     = document.createElement('a'); aICS.textContent     = 'Apple / .ics';
    aICS.href      = makeICSHref({ ...payload, uid: ev.iCalUID || ev.id });
    aICS.download  = (payload.title.replace(/[^\w\- ]+/g,'').trim() || 'event') + '.ics';

    menu.append(aGoogle, aOutlook, aICS);

    function closeMenus(){ menu.classList.add('hide'); }
    addBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hide'); });
    document.addEventListener('click', closeMenus);

    // assemble row
    row.append(thumb, body, addBtn, menu);  // addBtn/menu positioned absolutely in top-right
    wrap.appendChild(row);
  }
}

/* ========= Carousel arrows ========= */
function initRailNav(){
  const strip   = document.getElementById('strip');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  if (!strip || !prevBtn || !nextBtn) return;

  const eps = 1;
  const maxScrollLeft = el => el.scrollWidth - el.clientWidth;

  function updateArrows(){
    const max = maxScrollLeft(strip);
    const sl  = strip.scrollLeft;
    const noOverflow = max <= eps;
    prevBtn.disabled = noOverflow || sl <= eps;
    nextBtn.disabled = noOverflow || (max - sl) <= eps;
  }

  prevBtn.onclick = () => strip.scrollBy({ left: -strip.clientWidth, behavior:'smooth' });
  nextBtn.onclick = () => strip.scrollBy({ left:  strip.clientWidth, behavior:'smooth' });
  strip.addEventListener('scroll', updateArrows, { passive:true });
  window.addEventListener('resize', () => requestAnimationFrame(updateArrows));
  requestAnimationFrame(updateArrows);
}

/* ========= Tabs ========= */
function initTabs(){
  const tabCards  = document.getElementById('tabCards');
  const tabAgenda = document.getElementById('tabAgenda');
  const panelCards  = document.getElementById('panelCards');
  const panelAgenda = document.getElementById('panelAgenda');

  function select(which){
    const showCards = which === 'cards';
    tabCards.setAttribute('aria-selected', String(showCards));
    tabAgenda.setAttribute('aria-selected', String(!showCards));
    panelCards.hidden  = !showCards;
    panelAgenda.hidden = showCards;
    if (showCards) requestAnimationFrame(initRailNav);
  }
  tabCards.addEventListener('click',  ()=>select('cards'));
  tabAgenda.addEventListener('click', ()=>select('agenda'));
}

/* ========= Boot ========= */
(async function boot(){
  try{
    initTabs();
    const events = await fetchEvents();
    if (!events.length){ document.getElementById('empty').hidden = false; return; }
    renderCards(events);
    try { renderAgenda(events); } catch (e) { console.error('Agenda render failed:', e); }
  }catch(err){
    const e = document.getElementById('empty');
    e.hidden = false; e.textContent = 'Could not load events. (' + err.message + ')';
    console.error(err);
  }
})();
</script>
</body>
</html>
