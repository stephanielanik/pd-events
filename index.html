<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIT Professional Development Opportunities – Cards</title>
  <style>
    :root { --gap: 1rem; --radius: 16px; --shadow: 0 8px 24px rgba(0,0,0,.08); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; background: #fafbfc; color: #1a1a1a; }
    h1 { font-size: clamp(1.25rem, 1.2rem + 1vw, 1.75rem); margin: 0 0 12px; }
    .strip { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(280px, 360px); gap: var(--gap); overflow-x: auto; padding: var(--gap); scroll-snap-type: x mandatory; }
    .card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); scroll-snap-align: start; display: flex; flex-direction: column; }
    .img-wrap { position: relative; aspect-ratio: 16 / 9; overflow: hidden; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); background:#eef2f7; }
    .img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .content { padding: 14px 16px 16px; display: grid; gap: 8px; }
    .title { font-weight: 600; line-height: 1.25; }
    .meta { font-size: .9rem; color: #445; }
    .desc { font-size: .95rem; color: #333; max-height: 5.2em; overflow: clip; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
    .cta { display: inline-block; margin-top: 6px; padding: 10px 12px; border-radius: 10px; text-decoration: none; background:#0b6efd; color: #fff; font-weight: 600; }
    .empty { padding: 24px; color: #555; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
  <!--
    HOW TO USE
    1) Make your Google Calendar PUBLIC (Settings → Access permissions → Make available to public → See all event details)
    2) Copy CALENDAR_ID (Settings → Integrate calendar → Calendar ID)
    3) Create an API key (console.cloud.google.com → enable Google Calendar API → Credentials → API key). Restrict by HTTP referrers.
    4) Fill CALENDAR_ID and API_KEY below. Host this file on a public site (or GitHub Pages). Optionally iframe into Canvas.

    Authoring tip: add these tags as separate lines at the END of your event description (optional):
      BANNER: https://yourdomain.edu/path/image.jpg
      REGISTER: https://yourformlink
    They will be parsed and removed from the visible description.
  -->
</head>
<body>
  <h1>Upcoming Professional Development Opportunities</h1>
  <div id="strip" class="strip" role="list" aria-label="Upcoming events"></div>
  <div id="empty" class="empty" hidden>No upcoming events found.</div>

  <script>
    // === EDIT THESE ===
    const CALENDAR_ID = 'unkaitcalendar@gmail.com'; // e.g., abcd1234@group.calendar.google.com
    const API_KEY = 'AIzaSyBUJxL5LLxzrzutXCSGBcv28XJX02GhSIU';
    const MONTHS_AHEAD = 3; // how far to show
    const MAX_RESULTS = 50;
    const FALLBACK_IMAGE = 'https://stephanielanik.github.io/pd-events/images/aitevent.jpg'; // change to your hosted fallback

    // === Helpers ===
    function getRange() {
      const now = new Date();
      const end = new Date(); end.setMonth(end.getMonth() + MONTHS_AHEAD);
      return {
        timeMin: now.toISOString(),
        timeMax: end.toISOString()
      };
    }

    function htmlToText(html) {
      const d = document.createElement('div'); d.innerHTML = html || ''; 
      d.querySelectorAll('style,script').forEach(el => el.remove());
      const text = d.textContent || '';
      return text.replace(/\u00A0/g, ' ').replace(/\s+\n/g, '\n').trim();
    }

    function getTaggedUrl(desc, tag) {
  if (!desc) return '';
  // Match TAG: <url> anywhere (not just at line start)
  const re = new RegExp(tag + '\\s*:\\s*(https?:\\/\\/\\S+)', 'i');
  const m = desc.match(re);
  if (!m) return '';
  try { new URL(m[1]); return m[1]; } catch { return ''; }
}

   function sanitizeDesc(desc) {
  if (!desc) return '';
  // Remove any TAG: <url> occurrences (BANNER or REGISTER), even inline
  return desc
    .replace(/\\s*(BANNER|REGISTER)\\s*:\\s*https?:\\/\\/\\S+/gi, '')
    .replace(/\\n{3,}/g, '\\n\\n')
    .trim();
}

    function fmtRange(start, end, allDay) {
      const optsD = { weekday:'short', month:'short', day:'numeric' };
      const optsT = { hour:'numeric', minute:'2-digit' };
      const s = new Date(start), e = new Date(end || start);
      if (allDay) {
        const sameDay = s.toDateString() === e.toDateString();
        return sameDay ? s.toLocaleDateString(undefined, optsD)
                       : `${s.toLocaleDateString(undefined, optsD)} → ${e.toLocaleDateString(undefined, optsD)}`;
      } else {
        const sameDay = s.toDateString() === e.toDateString();
        const d1 = s.toLocaleDateString(undefined, optsD);
        const t1 = s.toLocaleTimeString(undefined, optsT);
        const t2 = e.toLocaleTimeString(undefined, optsT);
        return sameDay ? `${d1} • ${t1}–${t2}` : `${d1} ${t1} → ${e.toLocaleDateString(undefined, optsD)} ${t2}`;
      }
    }

    async function fetchEvents() {
      const { timeMin, timeMax } = getRange();
      const base = 'https://www.googleapis.com/calendar/v3/calendars/' + encodeURIComponent(CALENDAR_ID) + '/events';
      const url = new URL(base);
      url.searchParams.set('key', API_KEY);
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');
      url.searchParams.set('maxResults', String(MAX_RESULTS));
      url.searchParams.set('timeMin', timeMin);
      url.searchParams.set('timeMax', timeMax);

      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('Google API error ' + res.status);
      const data = await res.json();
      return (data.items || []).filter(ev => !ev.status || ev.status !== 'cancelled');
    }

    function getTimes(ev) {
      // Handles all-day (date) vs timed (dateTime)
      const s = ev.start?.dateTime || (ev.start?.date ? ev.start.date + 'T00:00:00' : null);
      const e = ev.end?.dateTime || (ev.end?.date ? ev.end.date + 'T00:00:00' : s);
      const allDay = !!ev.start?.date && !!ev.end?.date;
      return { start: s, end: e, allDay };
    }

    function render(events) {
      const strip = document.getElementById('strip');
      const empty = document.getElementById('empty');
      strip.innerHTML = '';
      if (!events.length) { empty.hidden = false; return; }
      empty.hidden = true;

      for (const ev of events) {
        const { start, end, allDay } = getTimes(ev);
        const when = fmtRange(start, end, allDay);
        const descHtml = ev.description || '';
        const descText = htmlToText(descHtml);
        const banner = getTaggedUrl(descText, 'BANNER') || FALLBACK_IMAGE;
        const signup = getTaggedUrl(descText, 'REGISTER');
        const descClean = sanitizeDesc(descText);

        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('role','listitem');

        const imgWrap = document.createElement('div');
        imgWrap.className = 'img-wrap';
        
        const img = document.createElement('img');
img.loading = 'lazy';
img.alt = '';
img.referrerPolicy = 'no-referrer';   // helps with some hosts
img.src = banner;
img.onerror = () => { img.src = FALLBACK_IMAGE; }; // use fallback if banner fails

        const c = document.createElement('div');
        c.className = 'content';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = ev.summary || 'Untitled event';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const where = ev.location ? ` • ${ev.location}` : '';
        meta.textContent = `${when}${where}`;

        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = descClean;

        c.append(title, meta, desc);

        if (signup) {
          const a = document.createElement('a');
          a.className = 'cta';
          a.href = signup; a.target = '_blank'; a.rel = 'noopener';
          a.textContent = 'Sign up';
          c.appendChild(a);
        }

        card.append(imgWrap, c);
        strip.appendChild(card);
      }
    }

    (async () => {
      try {
        const items = await fetchEvents();
        render(items);
      } catch (err) {
        document.getElementById('empty').hidden = false;
        document.getElementById('empty').textContent = 'Could not load events. (' + err.message + ')';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
